const puppeteer = require('puppeteer');
const axios = require('axios'); // Import axios for HTTP requests

(async () => {
    const browser = await puppeteer.launch({ headless: false });
    const page = await browser.newPage();

    // Navigate to the password-protected page
    await page.goto('https://www.missionmobilemed.com/care-capacity-counter', {
        waitUntil: 'networkidle2',
    });

    // Enter the password
    await page.type('input[type="password"]', 'MissionMed1!');

    // Handle the dialog/modal
    page.on('dialog', async (dialog) => {
        console.log('Dialog detected:', dialog.message());
        await dialog.accept();
    });

    // Submit the form programmatically
    await page.evaluate(() => {
        document.querySelector('input[type="submit"]').click();
    });

    // Wait for navigation to complete
    await page.waitForNavigation({ waitUntil: 'networkidle2' });

    console.log('Logged in successfully!');

    // Wait for dynamic content to load
    console.log('Waiting for the counter to fully load...');
    await page.waitForTimeout(10000);

    // Wait for the counter element to appear
    await page.waitForSelector('#num1_widget_1737660239621', { timeout: 30000 });

    // Extract the counter value
    const counterValue = await page.$eval('#num1_widget_1737660239621', (el) => {
        const text = el.textContent.trim();
        console.log('Raw Counter Text:', text);
        return parseInt(text.replace(/,/g, ''), 10);
    });

    if (isNaN(counterValue)) {
        console.error('Failed to extract a valid counter value.');
        await browser.close();
        return;
    }

    console.log('Counter Value:', counterValue);

    // Update the JSON file on GitHub
    const githubApiUrl = 'https://lsmith-m3.github.io//smiirl-counter/contents/counter.json';
    const token = 'your_personal_access_token'; // Replace with your GitHub Personal Access Token

    try {
        // Get the current file SHA
        const { data: fileData } = await axios.get(githubApiUrl, {
            headers: {
                Authorization: `Bearer ${token}`,
            },
        });

        const sha = fileData.sha;

        // Update the file content
        const response = await axios.put(
            githubApiUrl,
            {
                message: 'Update counter value',
                content: Buffer.from(JSON.stringify({ number: counterValue })).toString('base64'),
                sha: sha,
            },
            {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            }
        );

        if (response.status === 200) {
            console.log('Counter value updated on GitHub successfully!');
        } else {
            console.error('Failed to update GitHub:', response.status, response.statusText);
        }
    } catch (err) {
        console.error('Error updating GitHub:', err.message || err);
    }

    await browser.close();
})();
